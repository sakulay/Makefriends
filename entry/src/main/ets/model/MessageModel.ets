import { Client } from "@ohos/stompjs";
import { webSocket } from "@kit.NetworkKit";
import { BusinessError } from "@kit.BasicServicesKit";
import { MessageBase, TextDetailData } from "./Message";
import { dealImageResMsg } from "../utils/MessageUtils";
import { HttpConstant } from "../common/HttpConstant";
import { AuthenticationToken } from "../viewmodel/AuthModel";


let messageList = new TextDetailData()
const url: string = 'ws://192.168.209.225:8989/ws'
// const token: string = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdHVkZW50SWQiOiIxOSIsInN1YiI6IjE5IiwiZGF0YVNjb3BlIjowLCJleHAiOjE3NDUwMzg0MjYsImlhdCI6MTc0NTAzMTIyNiwiYXV0aG9yaXRpZXMiOlsiUk9MRV9TVFVERU5UIl0sImp0aSI6Ijc5OGJkNGY4NmViMjQyOWE4MDMxZjFjYzkzMTY3NDFmIn0.SEBeDf5n59w9vsbRGZwq2t21tFB4o2Dr4lIiySWeYYY'
const client: Client = new Client()
const ws = webSocket.createWebSocket()
const LOG = '[MessageModel]'

export class MessageModel {
  type: string;
  sender: string
  content: string;

  constructor(type: string, sender: string, content: string) {
    this.type = type;
    this.sender = sender;
    this.content = content;
  }
}
export enum MessageType {
  CHAT = "CHAT",
  UNREAD = "UNREAD"
}
export class Unread{
  sender: string;
  avatar: string;
  nickname: string;
  latestContent: string;
  unreadCount: string;
  constructor(sender: string, avatar: string, nickname: string, latestContent: string, unreadCount: string) {
    this.sender = sender;
    this.avatar = avatar;
    this.nickname = nickname;
    this.latestContent = latestContent;
    this.unreadCount = unreadCount;
  }
}

export function getUnreadList(): Array<Unread> {
  let list: Array<Unread> = []
  list.push(new Unread("19", "http://111.230.102.82:40061/i/2025/02/26/p1mi5m-0.jpg", "mike", "ä½ å¥½", '1'))
  list.push(new Unread("11", "http://111.230.102.82:40061/i/2025/02/26/p1mi5m-0.jpg", "anson", "ä½ å¥½1", '1'))
  list.push(new Unread("2101510218", "http://111.230.102.82:40061/i/2025/02/26/p1mi5m-0.jpg", "yuyu", "ä½ å¥½2", '1'))
  list.push(new Unread("4689", "http://111.230.102.82:40061/i/2025/02/26/p1mi5m-0.jpg", "ljc", "ä½ å¥½33333333", '1'))
  return list;
}
// æœªè¯»æ¶ˆæ¯åˆ—è¡¨
let unreadList: Array<Unread> = getUnreadList();

export function initMessage() {
  // å…¨å±€è®¾ç½®æœªè¯»æ¶ˆæ¯åˆ—è¡¨
  AppStorage.setOrCreate("unread", unreadList)
  // å…¨å±€è®¾ç½®æ¶ˆæ¯åˆ—è¡¨
  AppStorage.setOrCreate("message", messageList)
  // å…¨å±€è®¾ç½®å·²é€‰èŠå¤©ä¼šè¯
  AppStorage.setOrCreate("selectedChat", '')
  // å…¨å±€è®¾ç½®ws
  AppStorage.setOrCreate("ws", ws)
  connect()
}
export function connect() {

  ws.on('open', (err: BusinessError, value: Object) => {
    if (err) {
      console.log("âŒ è¿æ¥å¤±è´¥. Err:" + err.message);
      // this.message = 'è¿æ¥å¤±è´¥: ' + err.message + '\n' + this.message;
      return;
    }
    console.log("âœ… WebSocket è¿æ¥æˆåŠŸ");
    // this.message = 'è¿æ¥æˆåŠŸ' + '\n' + this.message;
    // å‘é€ STOMP è¿æ¥è¯·æ±‚
    const token = (AppStorage.get('auth') as AuthenticationToken).accessToken
    let connectFrame = "CONNECT\naccept-version:1.2\nAuthorization:AppBearer " + token + "\n\n\x00";
    ws.send(connectFrame, (err) => {
      if (err) {
        console.log("âŒ STOMP è¿æ¥å¤±è´¥:", JSON.stringify(err));
      } else {
        console.log("âœ… STOMP è¿æ¥è¯·æ±‚å·²å‘é€");
      }
    });
  })
  ws.on('close', (err: BusinessError, value: Object) => {
    if (err) {
      console.log("âŒ WebSocket å…³é—­é”™è¯¯:", JSON.stringify(err));
      // this.message = 'æ–­å¼€è¿æ¥å¤±è´¥ï¼š' + err.message +'\n' + this.message;
      return;
    }
    console.log("âœ… WebSocket è¿æ¥å·²å…³é—­");
    // this.message = 'æ–­å¼€è¿æ¥' + '\n' + this.message;
  });
  ws.on('error', (err: BusinessError) => {
    console.log(LOG, "on error, error: " + JSON.stringify(err));
  });
  ws.on('message', (err: BusinessError, value: string | ArrayBuffer) => {
    if (err) {
      console.log("âŒ WebSocket æ¶ˆæ¯é”™è¯¯:", JSON.stringify(err));
      return;
    }
    console.log("ğŸ“© æ”¶åˆ°æ¶ˆæ¯:", value);

    if (typeof value === 'string') {
      if (value.startsWith("CONNECTED")) {
        console.log("âœ… STOMP è¿æ¥æˆåŠŸ");
        // è®¢é˜…æ¶ˆæ¯
        let subscribeFrame1 = "SUBSCRIBE\nid:sub-0\ndestination:/user/queue/greeting\nack:auto\nreceipt:sub-receipt-1\n\n\x00";
        ws.send(subscribeFrame1, (err)=>{subscribeHandle(err)});
        let subscribeFrame2 = "SUBSCRIBE\nid:sub-1\ndestination:/topic/notice\nack:auto\nreceipt:sub-receipt-2\n\n\x00";
        ws.send(subscribeFrame2, (err)=>{subscribeHandle(err)});
        let subscribeFrame3 = "SUBSCRIBE\nid:sub-2\ndestination:/user/queue/unread\nack:auto\nreceipt:sub-receipt-3\n\n\x00";
        ws.send(subscribeFrame3, (err)=>{subscribeHandle(err)});

      } else if (value.startsWith("RECEIPT")) {
        console.log("âœ… è®¢é˜…æˆåŠŸï¼");
      } else {
        let lines = value.split("\n");  // æŒ‰è¡Œæ‹†åˆ†
        let lastLine = lines[lines.length - 1];  // è·å–æœ€åä¸€è¡Œ
        let message = JSON.parse(lastLine) as MessageModel; // æ‹¿åˆ°æ¶ˆæ¯
        // å¦‚æœæ˜¯èŠå¤©æ¶ˆæ¯
        if (message.type === MessageType.CHAT) {
          console.log("ğŸ“¥ æ”¶åˆ°èŠå¤©æ¶ˆæ¯:", message.content);
          const textDetailData = AppStorage.get('textDetailData') as TextDetailData
          // å¦‚æœå¼€å¯ä¼šè¯ï¼Œåˆ™æ›´æ–°èŠå¤©è®°å½•
          if(textDetailData) {
            const messageBase = new MessageBase(false, '', AppStorage.get('imageOther') as string, AppStorage.get('msgMaxWidth') as number)
            dealImageResMsg(messageBase, message.content)
            textDetailData.pushData(messageBase)
          }
        }
        else if (message.type === MessageType.UNREAD) { // æœªè¯»æ¶ˆæ¯
          console.log("ğŸ“¥ æ”¶åˆ°æœªè¯»æ¶ˆæ¯:", message.content);
          // æœªè¯»æ¶ˆæ¯æ˜¯ç°åœ¨è¿›è¡Œçš„ä¼šè¯
          let selectedChat: string | undefined = AppStorage.get('selectedChat')
          if(selectedChat !== '' && selectedChat == message.sender) return
          // æœªè¯»æ¶ˆæ¯ä¸æ˜¯ç°åœ¨è¿›è¡Œçš„ä¼šè¯
          const found = unreadList.find(item => item.sender === message.sender);
          // æœªè¯»æ¶ˆæ¯å­˜åœ¨
          if(found) {
            found.unreadCount = message.content.split('@')[0]
            found.latestContent = message.content.split('@')[1]
          } else {
            // æœªè¯»æ¶ˆæ¯ä¸å­˜åœ¨
            unreadList.push(message2Unread(message))
          }
          AppStorage.set("unread", unreadList)
        }
      }
    }
  });
  ws.connect(url)
}
export function disconnect() {
  if(ws) {
    ws.close()
  }
}

function subscribeHandle(err: BusinessError){
  if (err) {
    console.log("âŒ è®¢é˜…å¤±è´¥:", JSON.stringify(err));
  } else {
    console.log("âœ… user/queue/greetingè®¢é˜…è¯·æ±‚å·²å‘é€");
  }
}

function message2Unread(message: MessageModel) {
  let avatar = 'http://111.230.102.82:40061/i/2025/02/26/su2jeq-0.jpeg'
  let nickname = 'æœªå‘½å'
  return new Unread(
    message.sender,
    avatar,
    nickname,
    message.content.split('@')[1],
    message.content.split('@')[0]
  )
}

export function sendChatMessage(toUsername: string, content: string) {
  const user = AppStorage.get('selectedChat') as string
  const sendFrame =
    "SEND\n" +
      `destination:/app/sendToUser/${user}\n` +
      "content-type:application/json\n" +
      "\n" +
      `${JSON.stringify(content)}` + "\x00";

  ws.send(sendFrame, (err) => {
    if (err) {
      console.log("âŒ æ¶ˆæ¯å‘é€å¤±è´¥:", JSON.stringify(err));
    } else {
      console.log("âœ… æ¶ˆæ¯å·²å‘é€:", content);
    }
  });
}
